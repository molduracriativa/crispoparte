<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
    <title>Filtro Pro - Lucca</title>
    <style>
        :root { --accent: #25D366; --record: #ff0000; --boom: #e1306c; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: #000; color: #fff; overflow: hidden; width: 100vw; height: 100dvh; font-family: sans-serif; }

        .stage { position: relative; width: 100%; height: 100%; overflow: hidden; background: #000; touch-action: none; }
        #camera { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        #camera.mirrored { transform: scaleX(-1); }

        #editorCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 80; background: #000; display: none; touch-action: none; }
        #canvasPreview, #videoPreview { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; z-index: 20; background: #000; display: none; }
        
        /* ESSENCIAL PARA IPHONE: Imagem que o usu√°rio pode segurar para salvar */
        #iosImg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; z-index: 150; display: none; background: #000; }

        #molduraImagePreview { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; object-position: bottom; pointer-events: none; z-index: 15; display: none; }
        
        .ui-layer { position: absolute; inset: 0; pointer-events: none; z-index: 30; display: flex; flex-direction: column; justify-content: space-between; padding: 40px 20px; }
        .top-bar { display: flex; justify-content: space-between; pointer-events: auto; width: 100%; }
        
        .btn-m { padding: 10px 16px; background: rgba(0,0,0,0.6); border: 2px solid rgba(255,255,255,0.3); border-radius: 20px; color: #fff; cursor: pointer; font-weight: bold; font-size: 12px; }
        .btn-m.active { border-color: var(--accent); background: rgba(37, 211, 102, 0.4); }

        .controls-bottom { display: flex; flex-direction: column; align-items: center; pointer-events: auto; width: 100%; }
        .custom-controls-wrapper { position: relative; width: 100%; display: flex; justify-content: center; align-items: center; min-height: 140px; }
        .arte-botoes-bg { position: absolute; bottom: -5px; width: 100vw; max-width: 500px; pointer-events: none; z-index: 1; }
        
        .capture-controls { position: relative; z-index: 99; display: flex; gap: 10px; align-items: center; }
        .btn-hidden { opacity: 0; cursor: pointer; border: none; background: transparent; }
        .area-galeria { width: 55px; height: 55px; }
        .area-foto { width: 75px; height: 75px; }
        .area-video { width: 95px; height: 95px; }
        .area-boom { width: 65px; height: 65px; }

        #editUI { position: absolute; inset: 0; z-index: 90; display: none; flex-direction: column; justify-content: flex-end; align-items: center; padding-bottom: 60px; pointer-events: none; }
        #editUI button { pointer-events: auto; }

        #resultUI { position: absolute; inset: 0; z-index: 200; display: none; flex-direction: column; justify-content: flex-end; align-items: center; padding-bottom: 60px; pointer-events: auto; background: transparent; }
        .btn-res { width: 85%; padding: 18px; margin: 8px; border-radius: 20px; border: none; font-weight: bold; font-size: 16px; color: #fff; cursor: pointer; text-align: center; text-decoration: none; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        
        #iosTip { color: yellow; font-size: 14px; text-align: center; margin-bottom: 10px; display: none; text-shadow: 1px 1px 2px #000; }
        #startScreen { position: absolute; inset: 0; background: #000 url('capajpg.jpg') center/cover; display: flex; align-items: center; justify-content: center; z-index: 1000; }
        #startBtn { padding: 18px 45px; font-size: 18px; border-radius: 40px; border: none; background: #FF5722; color: #fff; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div class="stage" id="mainStage">
    <video id="camera" autoplay playsinline muted></video>
    <canvas id="editorCanvas"></canvas>
    <img id="iosImg" /> <canvas id="canvasPreview" style="display:none;"></canvas>
    <canvas id="canvasFinal" style="display:none;"></canvas>
    <video id="videoPreview" playsinline controls loop style="display:none; z-index:100;"></video>
    <img id="molduraImagePreview" src="moldura1.png" />
    
    <div id="cameraUI" class="ui-layer" style="display:none;">
        <div class="top-bar">
            <button class="btn-m" id="switchBtn">üîÑ INVERTER</button>
            <div class="moldura-selector">
                <button id="m1Btn" class="btn-m active">FOTO 1</button>
                <button id="m2Btn" class="btn-m">FOTO 2</button>
            </div>
        </div>
        <div class="controls-bottom">
            <div class="custom-controls-wrapper">
                <img src="botoes.png" class="arte-botoes-bg">
                <div class="capture-controls">
                    <button id="galleryBtn" class="btn-hidden area-galeria"></button>
                    <input type="file" id="fileInput" accept="image/*" style="display:none;">
                    <button id="capturePhotoBtn" class="btn-hidden area-foto"></button>
                    <button id="captureVideoBtn" class="btn-hidden area-video"></button>
                    <button id="boomerangBtn" class="btn-hidden area-boom"></button>
                </div>
            </div>
        </div>
    </div>

    <div id="editUI">
        <div style="margin-bottom:20px; font-weight: bold; color: #fff;">AJUSTE COM OS DEDOS</div>
        <button id="confirmEditBtn" class="btn-res" style="background:var(--accent);">‚úÖ CONFIRMAR</button>
        <button id="cancelEditBtn" class="btn-res" style="background:#444;">‚ùå CANCELAR</button>
    </div>

    <div id="resultUI">
        <div id="iosTip">Pressione na imagem para SALVAR na Galeria üëÜ</div>
        <a id="downloadBtn" class="btn-res" style="background:var(--accent);">üì• BAIXAR ARQUIVO</a>
        <button id="backToCameraBtn" class="btn-res" style="background:#444;">üîÑ TIRAR OUTRA</button>
    </div>
    
    <div id="startScreen"><button id="startBtn">INICIAR C√ÇMERA</button></div>
</div>

<script>
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
const MOLDURAS = { 'm1': 'moldura1.png', 'm2': 'moldura2.png' };
let currentKey = 'm1', isFront = true, stream = null;
let isEditing = false, galleryImg = new Image(), animId = null;
let transform = { x: 0, y: 0, sc: 1, lx: 0, ly: 0, ld: 0 };

const video = document.getElementById('camera'), editor = document.getElementById('editorCanvas'), eCtx = editor.getContext('2d');
const cFinal = document.getElementById('canvasFinal'), ctxF = cFinal.getContext('2d');
const molduraImg = document.getElementById('molduraImagePreview'), fileInput = document.getElementById('fileInput');
const iosImg = document.getElementById('iosImg');

document.getElementById('startBtn').onclick = initCamera;
document.getElementById('switchBtn').onclick = () => { isFront = !isFront; initCamera(); };
document.getElementById('m1Btn').onclick = () => switchMoldura('m1');
document.getElementById('m2Btn').onclick = () => switchMoldura('m2');

async function initCamera() {
    if(stream) stream.getTracks().forEach(t => t.stop());
    try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: isFront ? 'user' : 'environment', width: 1280, height: 720 }, audio: true });
        video.srcObject = stream;
        video.classList.toggle('mirrored', isFront);
        document.getElementById('startScreen').style.display = 'none';
        document.getElementById('cameraUI').style.display = 'flex';
    } catch (e) { alert("Erro ao acessar c√¢mera."); }
}

function switchMoldura(key) {
    currentKey = key;
    molduraImg.src = MOLDURAS[key];
    molduraImg.style.display = 'block';
    document.getElementById('m1Btn').classList.toggle('active', key === 'm1');
    document.getElementById('m2Btn').classList.toggle('active', key === 'm2');
}

// --- GALERIA COM TOQUE (FIX) ---
document.getElementById('galleryBtn').onclick = () => fileInput.click();
fileInput.onchange = e => {
    if (e.target.files[0]) {
        const reader = new FileReader();
        reader.onload = ev => {
            galleryImg = new Image();
            galleryImg.onload = () => {
                isEditing = true;
                document.getElementById('cameraUI').style.display = 'none';
                document.getElementById('editUI').style.display = 'flex';
                editor.style.display = 'block';
                editor.width = window.innerWidth; editor.height = window.innerHeight;
                const ratio = Math.min(editor.width / galleryImg.width, editor.height / galleryImg.height);
                transform.sc = ratio;
                transform.x = (editor.width - galleryImg.width * ratio) / 2;
                transform.y = (editor.height - galleryImg.height * ratio) / 2;
                renderEditor();
            };
            galleryImg.src = ev.target.result;
        };
        reader.readAsDataURL(e.target.files[0]);
    }
};

function renderEditor() {
    if (!isEditing) return;
    eCtx.fillStyle = "#000"; eCtx.fillRect(0, 0, editor.width, editor.height);
    eCtx.save();
    eCtx.translate(transform.x, transform.y);
    eCtx.scale(transform.sc, transform.sc);
    eCtx.drawImage(galleryImg, 0, 0);
    eCtx.restore();
    eCtx.drawImage(molduraImg, 0, 0, editor.width, editor.height);
    animId = requestAnimationFrame(renderEditor);
}

// Eventos de toque no Canvas
editor.addEventListener('touchstart', e => {
    if (e.touches.length === 1) {
        transform.lx = e.touches[0].clientX - transform.x;
        transform.ly = e.touches[0].clientY - transform.y;
    } else if (e.touches.length === 2) {
        transform.ld = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
    }
}, {passive: false});

editor.addEventListener('touchmove', e => {
    e.preventDefault();
    if (e.touches.length === 1) {
        transform.x = e.touches[0].clientX - transform.lx;
        transform.y = e.touches[0].clientY - transform.ly;
    } else if (e.touches.length === 2) {
        const d = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
        transform.sc *= (d / transform.ld);
        transform.ld = d;
    }
}, {passive: false});

document.getElementById('confirmEditBtn').onclick = () => {
    isEditing = false; cancelAnimationFrame(animId);
    cFinal.width = 1080; cFinal.height = 1920;
    const s = 1080 / editor.width;
    ctxF.save();
    ctxF.translate(transform.x * s, transform.y * s);
    ctxF.scale(transform.sc * s, transform.sc * s);
    ctxF.drawImage(galleryImg, 0, 0);
    ctxF.restore();
    ctxF.drawImage(molduraImg, 0, 0, 1080, 1920);
    showResult(cFinal.toDataURL('image/jpeg', 0.95), 'image');
};

// --- FOTO C√ÇMERA ---
document.getElementById('capturePhotoBtn').onclick = () => {
    cFinal.width = 1080; cFinal.height = 1920;
    ctxF.save();
    ctxF.translate(1080/2, 1920/2);
    if (isFront) ctxF.scale(-1, 1);
    const r = video.videoWidth / video.videoHeight;
    let dw = 1080, dh = 1080 / r;
    if (dh < 1920) { dh = 1920; dw = 1920 * r; }
    ctxF.drawImage(video, -dw/2, -dh/2, dw, dh);
    ctxF.restore();
    ctxF.drawImage(molduraImg, 0, 0, 1080, 1920);
    showResult(cFinal.toDataURL('image/jpeg', 0.95), 'image');
};

// --- RESULTADO (FIX IPHONE) ---
function showResult(url, type) {
    document.getElementById('cameraUI').style.display = 'none';
    document.getElementById('editUI').style.display = 'none';
    document.getElementById('resultUI').style.display = 'flex';
    editor.style.display = 'none';
    
    if (type === 'image') {
        iosImg.src = url;
        iosImg.style.display = 'block'; // Mostra a imagem real para o iOS
        if (isIOS) {
            document.getElementById('iosTip').style.display = 'block';
            document.getElementById('downloadBtn').style.display = 'none'; // No iOS o bot√£o de download costuma falhar, removemos para evitar confus√£o
        }
    } else {
        document.getElementById('videoPreview').style.display = 'block';
        document.getElementById('videoPreview').src = url;
    }
    document.getElementById('downloadBtn').href = url;
    document.getElementById('downloadBtn').download = `lucca_${Date.now()}.jpg`;
}

document.getElementById('backToCameraBtn').onclick = () => {
    document.getElementById('resultUI').style.display = 'none';
    document.getElementById('cameraUI').style.display = 'flex';
    iosImg.style.display = 'none';
    document.getElementById('videoPreview').style.display = 'none';
    document.getElementById('videoPreview').pause();
};

document.getElementById('cancelEditBtn').onclick = () => {
    isEditing = false; cancelAnimationFrame(animId);
    editor.style.display = 'none';
    document.getElementById('editUI').style.display = 'none';
    document.getElementById('cameraUI').style.display = 'flex';
};
</script>
</body>
</html>

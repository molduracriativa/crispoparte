<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Lucca 1 Ano</title>
  <style>
    :root { --accent: #25D366; --primary: #FF5722; }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; background: #000; color: #fff; overflow: hidden; width: 100vw; height: 100dvh; font-family: sans-serif; }

    /* √Årea da C√¢mera */
    .stage { position: relative; width: 100%; height: 100%; overflow: hidden; background: #000; }
    video, #molduraPreview, #canvasPreview, #iosFinalImage { 
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; 
    }
    
    /* Espelhamento selfie */
    video.mirrored { transform: scaleX(-1); }
    #molduraPreview { pointer-events: none; z-index: 5; }
    #canvasPreview { display: none; z-index: 6; }
    #iosFinalImage { display: none; z-index: 25; pointer-events: auto; }

    /* Interface */
    .ui-layer { position: absolute; inset: 0; pointer-events: none; z-index: 30; display: flex; flex-direction: column; justify-content: space-between; padding: 30px 20px; }
    .top-bar { display: flex; justify-content: flex-end; pointer-events: auto; }
    .controls-bottom { display: flex; flex-direction: column; align-items: center; pointer-events: auto; padding-bottom: 30px; }

    /* Bot√µes */
    .btn-ui { padding: 10px 20px; background: rgba(0,0,0,0.5); border: 1px solid #fff; border-radius: 20px; color: #fff; font-weight: bold; }
    
    #captureBtn { 
      width: 80px; height: 80px; border-radius: 50%; border: 5px solid #fff; 
      background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center;
    }
    #captureBtn svg { width: 40px; height: 40px; fill: #fff; }

    /* Resultado e A√ß√µes */
    #postCaptureActions { display: none; flex-direction: column; gap: 12px; width: 100%; max-width: 320px; pointer-events: auto; }
    .action-btn { width: 100%; padding: 18px; border-radius: 15px; border: none; font-size: 16px; font-weight: bold; color: #fff; cursor: pointer; text-align: center; text-decoration: none; }
    .btn-save { background: var(--accent); }
    .btn-new { background: #444; }

    #iosTip { font-size: 14px; color: #ffeb3b; text-align: center; margin-bottom: 10px; display: none; }
    #startScreen { position: absolute; inset: 0; background: #000 url('capajpg.jpg') center/cover no-repeat; z-index: 100; display: flex; align-items: center; justify-content: center; }
    #startBtn { padding: 20px 40px; font-size: 20px; background: var(--primary); color: #fff; border: none; border-radius: 50px; font-weight: bold; }
    
    .flash { position: absolute; inset: 0; background: #fff; opacity: 0; pointer-events: none; z-index: 40; }
  </style>
</head>
<body>

  <div class="stage">
    <video id="camera" autoplay playsinline muted></video>
    <canvas id="canvasPreview"></canvas>
    <img id="iosFinalImage" />
    <img id="molduraPreview" src="moldura1.png" />
    <div class="flash" id="flash"></div>

    <div class="ui-layer" id="cameraUI" style="display: none;">
      <div class="top-bar"><button class="btn-ui" id="switchBtn">üîÑ INVERTER</button></div>
      <div class="controls-bottom">
        <button id="captureBtn">
          <svg viewBox="0 0 24 24"><path d="M12 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/><path d="M20 5h-3.17L15 3H9L7.17 5H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 14H4V7h16v12z"/></svg>
        </button>
      </div>
    </div>

    <div class="ui-layer" id="resultUI" style="display: none; justify-content: flex-end; align-items: center;">
      <div id="postCaptureActions">
        <div id="iosTip">üëÜ Segure na foto para salvar</div>
        <button id="shareBtn" class="action-btn btn-save">üì§ COMPARTILHAR / SALVAR</button>
        <button id="newPhotoBtn" class="action-btn btn-new">üîÑ VOLTAR</button>
      </div>
    </div>
  </div>

  <div id="startScreen"><button id="startBtn">INICIAR C√ÇMERA</button></div>

  <canvas id="canvasFinal" style="display: none;"></canvas>

  <script>
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    let usingFrontCamera = true;
    let stream = null;

    const video = document.getElementById('camera');
    const canvasFinal = document.getElementById('canvasFinal');
    const ctxFinal = canvasFinal.getContext('2d');
    const iosFinalImage = document.getElementById('iosFinalImage');
    const molduraPreview = document.getElementById('molduraPreview');
    
    document.getElementById('startBtn').onclick = initCamera;
    document.getElementById('switchBtn').onclick = () => { usingFrontCamera = !usingFrontCamera; initCamera(); };
    document.getElementById('captureBtn').onclick = takePhoto;
    document.getElementById('newPhotoBtn').onclick = reset;

    async function initCamera() {
      if (stream) stream.getTracks().forEach(t => t.stop());
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: usingFrontCamera ? 'user' : 'environment' } });
        video.srcObject = stream;
        video.classList.toggle('mirrored', usingFrontCamera);
        video.onloadedmetadata = () => {
          video.play();
          document.getElementById('startScreen').style.display = 'none';
          document.getElementById('cameraUI').style.display = 'flex';
        };
      } catch (e) { alert("C√¢mera indispon√≠vel"); }
    }

    function takePhoto() {
      // Flash
      document.getElementById('flash').style.opacity = '1';
      setTimeout(() => document.getElementById('flash').style.opacity = '0', 100);

      canvasFinal.width = 1080; canvasFinal.height = 1920;
      
      // Desenha foto
      const vW = video.videoWidth, vH = video.videoHeight;
      const ratio = vW / vH, targetRatio = 1080 / 1920;
      let dW, dH, sX, sY;

      if (ratio > targetRatio) { dH = 1920; dW = 1920 * ratio; sX = (1080 - dW) / 2; sY = 0; }
      else { dW = 1080; dH = 1080 / ratio; sX = 0; sY = (1920 - dH) / 2; }

      ctxFinal.save();
      if (usingFrontCamera) { ctxFinal.translate(1080, 0); ctxFinal.scale(-1, 1); }
      ctxFinal.drawImage(video, sX, sY, dW, dH);
      ctxFinal.restore();

      // Aplica Moldura
      const imgM = new Image();
      imgM.onload = () => {
        ctxFinal.drawImage(imgM, 0, 0, 1080, 1920);
        const dataUrl = canvasFinal.toDataURL('image/jpeg', 0.9);
        
        iosFinalImage.src = dataUrl;
        iosFinalImage.style.display = 'block';
        video.style.display = 'none';
        molduraPreview.style.display = 'none';
        
        document.getElementById('cameraUI').style.display = 'none';
        document.getElementById('resultUI').style.display = 'flex';
        document.getElementById('postCaptureActions').style.display = 'flex';
        if (isIOS) document.getElementById('iosTip').style.display = 'block';

        // Configura Compartilhar
        document.getElementById('shareBtn').onclick = async () => {
          const blob = await (await fetch(dataUrl)).blob();
          const file = new File([blob], "foto.jpg", { type: "image/jpeg" });
          if (navigator.share && navigator.canShare({ files: [file] })) {
            navigator.share({ files: [file] });
          } else {
            const a = document.createElement('a'); a.href = dataUrl; a.download = 'foto.jpg'; a.click();
          }
        };
      };
      imgM.src = 'moldura1.png';
    }

    function reset() {
      iosFinalImage.style.display = 'none';
      video.style.display = 'block';
      molduraPreview.style.display = 'block';
      document.getElementById('resultUI').style.display = 'none';
      document.getElementById('cameraUI').style.display = 'flex';
    }
  </script>
</body>
</html>
